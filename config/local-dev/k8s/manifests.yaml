
#
# eventstream-nexus development stack for Kubernetes
# Generated from docker-compose conversion
#

apiVersion: v1
kind: Namespace
metadata:
  name: eventstream-local
  labels:
    app: eventstream-nexus
---
apiVersion: v1
kind: Secret
metadata:
  name: eventstream-secrets
  namespace: eventstream-local
  labels:
    app: eventstream-nexus
    component: shared-secrets
type: Opaque
stringData:
  EVENTSTREAM_LIQUIBASE_PASSWORD: ${EVENTSTREAM_LIQUIBASE_PASSWORD}
  EVENTSTREAM_APP_PASSWORD: ${EVENTSTREAM_APP_PASSWORD}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-sql
  namespace: eventstream-local
  labels:
    app: eventstream-nexus
    component: postgres
data:
  init-eventstream-schema.sql: |
    -- Create the eventstream schema if it doesn't exist
    CREATE SCHEMA IF NOT EXISTS eventstream;
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: liquibase-changelogs
  namespace: eventstream-local
  labels:
    app: eventstream-nexus
    component: liquibase
data:
  changelog-master.yaml: |
    databaseChangeLog:
      - include:
          file: changes/001-init-user.yaml
      - include:
          file: changes/002-add-client-table.yaml
      - include:
          file: changes/003-add-idempotency-table.yaml
      - include:
          file: changes/004-add-shedlock-table.yaml
  001-init-user.yaml: |
    databaseChangeLog:
      - changeSet:
          id: 001-create-app-user
          author: lmo
          changes:
            - sql:
                sql: |
                  CREATE ROLE eventstream_rw;
                  GRANT USAGE ON SCHEMA eventstream TO eventstream_rw;
                  ALTER DEFAULT PRIVILEGES IN SCHEMA eventstream
                  GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO eventstream_rw;

                  -- use environment variable for password, see docker-compose.yaml
                  CREATE USER eventstream_app WITH PASSWORD '${EVENTSTREAM_APP_PASSWORD}';

                  ALTER ROLE eventstream_app SET search_path TO eventstream;
                  GRANT eventstream_rw TO eventstream_app;
  002-add-client-table.yaml: |
    databaseChangeLog:
      - changeSet:
          id: 002-add-client-table
          author: lmo
          changes:
            - createTable:
                tableName: clients
                columns:
                  - column:
                      name: id
                      type: BIGINT
                      autoIncrement: true
                      constraints:
                        primaryKey: true
                        nullable: false

                  - column:
                      name: name
                      type: VARCHAR(255)
                      constraints:
                        nullable: false

                  - column:
                      name: email
                      type: VARCHAR(255)
                      constraints:
                        nullable: false

                  - column:
                      name: created_at
                      type: TIMESTAMP WITH TIME ZONE
                      defaultValueComputed: CURRENT_TIMESTAMP
                      constraints:
                        nullable: false

                  - column:
                      name: updated_at
                      type: TIMESTAMP WITH TIME ZONE
                      defaultValueComputed: CURRENT_TIMESTAMP
                      constraints:
                        nullable: false

            - addUniqueConstraint:
                tableName: clients
                columnNames: email
                constraintName: uq_clients_email
  003-add-idempotency-table.yaml: |
    databaseChangeLog:
      - changeSet:
          id: 003-add-idempotency-table
          author: lmo
          changes:
            - createTable:
                tableName: idempotency_keys
                columns:
                  - column:
                      name: key
                      type: UUID
                      constraints:
                        primaryKey: true
                        nullable: false

                  - column:
                      name: created_at
                      type: TIMESTAMP WITH TIME ZONE
                      defaultValueComputed: CURRENT_TIMESTAMP
                      constraints:
                        nullable: false
  004-add-shedlock-table.yaml: |
    databaseChangeLog:
      - changeSet:
          id: 004-add-shedlock-table
          author: lmo
          changes:
            - createTable:
                tableName: shedlock
                columns:
                  - column:
                      name: name
                      type: VARCHAR(64)
                      constraints:
                        primaryKey: true
                        nullable: false

                  - column:
                      name: lock_until
                      type: TIMESTAMP WITH TIME ZONE
                      constraints:
                        nullable: false

                  - column:
                      name: locked_at
                      type: TIMESTAMP WITH TIME ZONE
                      constraints:
                        nullable: false

                  - column:
                      name: locked_by
                      type: VARCHAR(255)
                      constraints:
                        nullable: false
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: eventstream-local
  labels:
    app: eventstream-nexus
    component: postgres
spec:
  selector:
    app: eventstream-nexus
    component: postgres
  ports:
    - name: postgres
      port: 5432
      targetPort: 5432
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: eventstream-local
  labels:
    app: eventstream-nexus
    component: postgres
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: eventstream-nexus
      component: postgres
  template:
    metadata:
      labels:
        app: eventstream-nexus
        component: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:16
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_DB
              value: eventstream
            - name: POSTGRES_USER
              value: eventstream_liquibase
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: eventstream-secrets
                  key: EVENTSTREAM_LIQUIBASE_PASSWORD
          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data
            - name: init-sql
              mountPath: /docker-entrypoint-initdb.d
              readOnly: true
          readinessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - eventstream_liquibase
                - -d
                - eventstream
            initialDelaySeconds: 10
            periodSeconds: 5
          livenessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - eventstream_liquibase
                - -d
                - eventstream
            initialDelaySeconds: 30
            periodSeconds: 10
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 500m
              memory: 1Gi
      volumes:
        - name: init-sql
          configMap:
            name: postgres-init-sql
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
---
apiVersion: batch/v1
kind: Job
metadata:
  name: liquibase-migrate
  namespace: eventstream-local
  labels:
    app: eventstream-nexus
    component: liquibase
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: eventstream-nexus
        component: liquibase
    spec:
      restartPolicy: OnFailure
      containers:
        - name: liquibase
          image: liquibase/liquibase:latest
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - >-
              until pg_isready -h postgres -p 5432 -U eventstream_liquibase -d eventstream; do
                sleep 2;
              done;
              liquibase update
          env:
            - name: LIQUIBASE_COMMAND_CHANGELOG_FILE
              value: changelog-master.yaml
            - name: LIQUIBASE_COMMAND_URL
              value: jdbc:postgresql://postgres:5432/eventstream?currentSchema=eventstream
            - name: LIQUIBASE_COMMAND_USERNAME
              value: eventstream_liquibase
            - name: LIQUIBASE_COMMAND_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: eventstream-secrets
                  key: EVENTSTREAM_LIQUIBASE_PASSWORD
            - name: LIQUIBASE_LOG_LEVEL
              value: INFO
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: eventstream-secrets
                  key: EVENTSTREAM_LIQUIBASE_PASSWORD
            - name: EVENTSTREAM_APP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: eventstream-secrets
                  key: EVENTSTREAM_APP_PASSWORD
          volumeMounts:
            - name: changelogs
              mountPath: /liquibase
              readOnly: true
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 250m
              memory: 512Mi
      volumes:
        - name: changelogs
          configMap:
            name: liquibase-changelogs
            items:
              - key: changelog-master.yaml
                path: changelog-master.yaml
              - key: 001-init-user.yaml
                path: changes/001-init-user.yaml
              - key: 002-add-client-table.yaml
                path: changes/002-add-client-table.yaml
              - key: 003-add-idempotency-table.yaml
                path: changes/003-add-idempotency-table.yaml
              - key: 004-add-shedlock-table.yaml
                path: changes/004-add-shedlock-table.yaml
---
apiVersion: v1
kind: Service
metadata:
  name: kafka
  namespace: eventstream-local
  labels:
    app: eventstream-nexus
    component: kafka
spec:
  selector:
    app: eventstream-nexus
    component: kafka
  ports:
    - name: plaintext
      port: 9092
      targetPort: 9092
    - name: controller
      port: 9093
      targetPort: 9093
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kafka
  namespace: eventstream-local
  labels:
    app: eventstream-nexus
    component: kafka
spec:
  serviceName: kafka
  replicas: 1
  selector:
    matchLabels:
      app: eventstream-nexus
      component: kafka
  template:
    metadata:
      labels:
        app: eventstream-nexus
        component: kafka
    spec:
      securityContext:
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 0
      containers:
        - name: kafka
          image: apache/kafka:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 9092
            - containerPort: 9093
          env:
            - name: KAFKA_NODE_ID
              value: "1"
            - name: KAFKA_PROCESS_ROLES
              value: broker,controller
            - name: KAFKA_CONTROLLER_QUORUM_VOTERS
              value: 1@kafka:9093
            - name: KAFKA_CLUSTER_ID
              value: MkU3OEVBNTcwNTJENDM2Qk
            - name: KAFKA_LISTENERS
              value: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
            - name: KAFKA_ADVERTISED_LISTENERS
              value: PLAINTEXT://kafka:9092
            - name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP
              value: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
            - name: KAFKA_INTER_BROKER_LISTENER_NAME
              value: PLAINTEXT
            - name: KAFKA_CONTROLLER_LISTENER_NAMES
              value: CONTROLLER
            - name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR
              value: "1"
            - name: KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR
              value: "1"
            - name: KAFKA_TRANSACTION_STATE_LOG_MIN_ISR
              value: "1"
            - name: KAFKA_MIN_INSYNC_REPLICAS
              value: "1"
            - name: KAFKA_DEFAULT_REPLICATION_FACTOR
              value: "1"
            - name: KAFKA_LOG_DIRS
              value: /var/lib/kafka/data
            - name: KAFKA_METADATA_LOG_DIR
              value: /var/lib/kafka/metadata
            - name: KAFKA_AUTO_CREATE_TOPICS_ENABLE
              value: "false"
          volumeMounts:
            - name: data
              mountPath: /var/lib/kafka/data
            - name: metadata
              mountPath: /var/lib/kafka/metadata
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - /opt/kafka/bin/kafka-topics.sh --list --bootstrap-server localhost:9092
            initialDelaySeconds: 25
            periodSeconds: 10
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - /opt/kafka/bin/kafka-topics.sh --list --bootstrap-server localhost:9092
            initialDelaySeconds: 60
            periodSeconds: 20
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: "1"
              memory: 2Gi
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
    - metadata:
        name: metadata
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
---
apiVersion: batch/v1
kind: Job
metadata:
  name: kafka-topic-init
  namespace: eventstream-local
  labels:
    app: eventstream-nexus
    component: kafka-topic-init
spec:
  backoffLimit: 5
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: eventstream-nexus
        component: kafka-topic-init
    spec:
      restartPolicy: OnFailure
      containers:
        - name: topic-init
          image: apache/kafka:latest
          imagePullPolicy: IfNotPresent
          command:
            - /bin/bash
            - -ec
            - |
              until /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9092 --list >/dev/null 2>&1; do
                sleep 3;
              done
              /opt/kafka/bin/kafka-topics.sh --create --topic client-created --partitions 3 --replication-factor 1 --if-not-exists --bootstrap-server kafka:9092
              /opt/kafka/bin/kafka-topics.sh --create --topic client-updated --partitions 3 --replication-factor 1 --if-not-exists --bootstrap-server kafka:9092
              /opt/kafka/bin/kafka-topics.sh --create --topic client-deleted --partitions 3 --replication-factor 1 --if-not-exists --bootstrap-server kafka:9092
              /opt/kafka/bin/kafka-topics.sh --create --topic _schemas --partitions 1 --replication-factor 1 --config cleanup.policy=compact --if-not-exists --bootstrap-server kafka:9092
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 250m
              memory: 256Mi
---
apiVersion: v1
kind: Service
metadata:
  name: schema-registry
  namespace: eventstream-local
  labels:
    app: eventstream-nexus
    component: schema-registry
spec:
  selector:
    app: eventstream-nexus
    component: schema-registry
  ports:
    - name: http
      port: 8081
      targetPort: 8081
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: schema-registry
  namespace: eventstream-local
  labels:
    app: eventstream-nexus
    component: schema-registry
spec:
  replicas: 1
  selector:
    matchLabels:
      app: eventstream-nexus
      component: schema-registry
  template:
    metadata:
      labels:
        app: eventstream-nexus
        component: schema-registry
    spec:
      initContainers:
        - name: wait-for-kafka-topics
          image: apache/kafka:latest
          command:
            - /bin/bash
            - -ec
            - |
              until /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9092 --describe --topic _schemas >/dev/null 2>&1; do
                sleep 3;
              done
      containers:
        - name: schema-registry
          image: confluentinc/cp-schema-registry:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8081
          env:
            - name: SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS
              value: PLAINTEXT://kafka:9092
            - name: SCHEMA_REGISTRY_LISTENERS
              value: http://0.0.0.0:8081
            - name: SCHEMA_REGISTRY_HOST_NAME
              value: schema-registry
          readinessProbe:
            httpGet:
              path: /subjects
              port: 8081
            initialDelaySeconds: 15
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /subjects
              port: 8081
            initialDelaySeconds: 60
            periodSeconds: 30
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
---
apiVersion: v1
kind: Service
metadata:
  name: eventstream-app
  namespace: eventstream-local
  labels:
    app: eventstream-nexus
    component: app
spec:
  selector:
    app: eventstream-nexus
    component: app
  ports:
    - name: http
      port: 8080
      targetPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: eventstream-app
  namespace: eventstream-local
  labels:
    app: eventstream-nexus
    component: app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: eventstream-nexus
      component: app
  template:
    metadata:
      labels:
        app: eventstream-nexus
        component: app
    spec:
      initContainers:
        - name: wait-for-postgres
          image: postgres:16
          command:
            - /bin/sh
            - -c
            - |
              until pg_isready -h postgres -p 5432 -U eventstream_liquibase -d eventstream; do
                sleep 3;
              done
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: eventstream-secrets
                  key: EVENTSTREAM_LIQUIBASE_PASSWORD
        - name: wait-for-kafka
          image: busybox:1.36
          command:
            - /bin/sh
            - -c
            - |
              until nc -z schema-registry 8081; do
                sleep 3;
              done
      containers:
        - name: eventstream-app
          image: eventstream-nexus:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          env:
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://postgres:5432/eventstream?currentSchema=eventstream
            - name: SPRING_KAFKA_BOOTSTRAP_SERVERS
              value: kafka:9092
            - name: SPRING_KAFKA_PRODUCER_PROPERTIES_SCHEMA_REGISTRY_URL
              value: http://schema-registry:8081
            - name: SPRING_KAFKA_CONSUMER_PROPERTIES_SCHEMA_REGISTRY_URL
              value: http://schema-registry:8081
            - name: EVENTSTREAM_APP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: eventstream-secrets
                  key: EVENTSTREAM_APP_PASSWORD
          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: 8080
            initialDelaySeconds: 20
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 30
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 500m
              memory: 1Gi
